name: GitHub Actions Ensure SHA Pinned Actions
description: Ensures all GitHub Actions use SHA-pinned versions instead of tag references
author: Alfresco

inputs:
  allowlist:
    description: |
      List of action patterns to exclude from SHA pinning (one per line).
      Supports wildcards with *, e.g., 'owner/repo/*' or 'owner/*'.
      Can also specify specific actions like 'owner/repo/action@v1.0.0'.
    required: false
    default: ''

  exclude-first-party:
    description: |
      Whether to exclude first-party actions (actions from same owner as current repo).
      Set to 'true' to skip checking actions from the same GitHub organization.
    required: false
    default: 'false'

  discovery:
    description: |
      When set to 'true', only discovers and lists actions without making API calls.
      Faster execution but won't provide SHA conversion information.
      Ignored if dry-run is also set to 'true'.
    required: false
    default: 'true'

  dry-run:
    description: |
      When set to 'true', reports what would be changed without making modifications.
      Takes precedence over discovery mode. Requires GitHub token for API calls.
      If no token is available, automatically falls back to discovery mode.
    required: false
    default: 'true'

  github-token:
    description: |
      GitHub token for API access. Uses GITHUB_TOKEN by default.
      Required for SHA resolution unless running in discovery mode.
    required: false
    default: ${{ github.token }}

  path:
    description: |
      Path to search for GitHub Actions workflows and actions.
      Defaults to current repository root.
    required: false
    default: '.'

runs:
  using: composite
  steps:
    - name: Install Python dependencies
      shell: bash
      run: |
        python -m pip install --upgrade pip
        pip install -r ${{ github.action_path }}/requirements.txt

    - name: Run GitHub Actions SHA Converter
      id: sha-convert
      shell: bash
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
      run: |
        # Build command arguments
        args=()
        args+=("--path" "${{ inputs.path }}")

        if [[ "${{ inputs.dry-run }}" == "true" ]]; then
          args+=("--dry-run")
        fi

        if [[ "${{ inputs.discovery }}" == "true" ]]; then
          args+=("--discovery")
        fi

        if [[ "${{ inputs.exclude-first-party }}" == "true" ]]; then
          args+=("--exclude-first-party")
        fi

        # Handle allowlist - write to temp file if provided
        if [[ -n "${{ inputs.allowlist }}" ]]; then
          allowlist_file=$(mktemp)
          echo '${{ inputs.allowlist }}' > "$allowlist_file"
          args+=("--allowlist" "$allowlist_file")
        fi

        echo "Running: python ${{ github.action_path }}/gha_sha_convert.py ${args[*]}"

        # Capture output and statistics
        output=$(python ${{ github.action_path }}/gha_sha_convert.py "${args[@]}" 2>&1) || exit_code=$?

        echo "$output"

        # Show git diff only if actual changes were made (not in dry-run or discovery mode)
        if [[ "$exit_code" -eq 1 && "${{ inputs.dry-run }}" != "true" && "${{ inputs.discovery }}" != "true" ]]; then
          echo ""
          echo "=== Git diff of changes made ==="
          git diff --color=always || echo "No changes to display (files may have been added/removed)"
          echo "================================"
        fi

        # Clean up temp file if created
        if [[ -n "${{ inputs.allowlist }}" ]]; then
          rm -f "$allowlist_file"
        fi

        # Exit with the same code as the Python script
        exit ${exit_code:-0}

branding:
  icon: shield
  color: blue
