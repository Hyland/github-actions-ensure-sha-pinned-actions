name: Test

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  pull_request_review:
    types:
      - submitted

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref_name || github.run_id }}
  cancel-in-progress: ${{ github.event_name != 'push' }}

permissions:
  contents: read

jobs:
  pre-checks:
    # Trigger a run when approving a bot PR or as usual
    if: >-
      (github.event.review.state == 'approved' && contains(fromJSON('["dependabot[bot]", "github-actions[bot]"]'), github.event.pull_request.user.login)) ||
      (github.actor != 'dependabot[bot]' && github.event_name != 'pull_request_review')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Run pre-commit
        uses: pre-commit/action@2c7b3805fd2a0fd8c1884dcaebf91fc102a13ecd # v3.0.1

  python-tests:
    runs-on: ubuntu-latest
    needs: pre-checks
    strategy:
      matrix:
        python-version:
          - '3.9'
          - '3.10'
          - '3.11'
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run unit tests
        run: |
          python -m unittest test_gha_sha_convert -v

      - name: Test CLI functionality
        run: |
          # Test help output
          python gha_sha_convert.py --help

          # Test discovery mode (safe, no API calls)
          python gha_sha_convert.py --discovery --path .

          # Test with exclude-first-party in discovery mode
          python gha_sha_convert.py --discovery --exclude-first-party --path .

          # Test syntax validation
          python -m py_compile gha_sha_convert.py
          python -m py_compile test_gha_sha_convert.py

      - name: Test pre-commit hook functionality
        run: |
          # Create a test workflow file
          mkdir -p .github/workflows
          cat > .github/workflows/test.yml << 'EOF'
          name: Test
          on: [push]
          jobs:
            test:
              runs-on: ubuntu-latest
              steps:
                - uses: actions/checkout@v4
                - uses: actions/setup-node@v3.8.1
          EOF

          # Test discovery on the test file
          python gha_sha_convert.py --discovery .github/workflows/test.yml

          # Test exclude-first-party on the test file
          python gha_sha_convert.py --discovery --exclude-first-party .github/workflows/test.yml

  python-integration-tests:
    runs-on: ubuntu-latest
    needs: python-tests
    if: github.event_name == 'pull_request'
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Set up Python
        uses: actions/setup-python@0b93645e9fea7318ecaed2b359559ac225c90a2b # v5.3.0
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Test actual workflow processing (discovery mode)
        run: |
          # Test on actual workflow files in the repository
          python gha_sha_convert.py --discovery --path ../.github/workflows

      - name: Test error handling
        run: |
          # Test with non-existent file (should handle gracefully)
          python gha_sha_convert.py --discovery non-existent-file.yml || echo "Handled error correctly"

          # Test with invalid YAML (should handle gracefully)
          echo "invalid: yaml: content: [" > invalid.yml
          python gha_sha_convert.py --discovery invalid.yml || echo "Handled invalid YAML correctly"
          rm -f invalid.yml
