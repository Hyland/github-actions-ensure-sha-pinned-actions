name: Release

on:
  pull_request:
    types:
      - closed
  workflow_dispatch:
    inputs:
      release_type:
        description: "Release type"
        required: true
        type: choice
        options:
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    if: ${{ github.event.pull_request.merged == true || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0

      - name: Get release type from PR label
        id: set-release-level
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            let level = '';
            if (context.payload.pull_request) {
              const labels = context.payload.pull_request.labels.map(label => label.name);
              if (labels.includes('release/major')) {
                level = 'major';
              } else if (labels.includes('release/minor')) {
                level = 'minor';
              } else if (labels.includes('release/patch')) {
                level = 'patch';
              }
            }
            else {
              level = context.payload.inputs.release_type;
            }

            core.setOutput('release-level', level);
            return level;

      - name: Get latest tag and bump version
        id: bump-semver
        if: ${{ steps.set-release-level.outputs.release-level != '' }}
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          if [[ "$LATEST_TAG" =~ ^v?([0-9]+)\.([0-9]+)\.([0-9]+)(-.+)?$ ]]; then
            MAJOR="${BASH_REMATCH[1]}"
            MINOR="${BASH_REMATCH[2]}"
            PATCH="${BASH_REMATCH[3]}"
          else
            MAJOR=0
            MINOR=0
            PATCH=0
          fi

          # Bump version based on release level
          case "${{ steps.set-release-level.outputs.release-level }}" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
          echo "new-version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Create and push tag
        if: ${{ steps.set-release-level.outputs.release-level != '' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git tag -a "${{ steps.bump-semver.outputs.new-version }}" -m "Release ${{ steps.bump-semver.outputs.new-version }}"
          git push origin "${{ steps.bump-semver.outputs.new-version }}"

      - name: Generate release notes
        if: ${{ steps.set-release-level.outputs.release-level != '' }}
        env:
          GH_TOKEN: ${{ github.token }}
        run: gh release create "${{ steps.bump-semver.outputs.new-version }}" --generate-notes -t "${{ steps.bump-semver.outputs.new-version }}"
